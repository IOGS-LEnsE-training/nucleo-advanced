<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signal Processing / Real-time FFT &mdash; Nucleo Advanced 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/css/lense-training.css?v=69701ec4" />
      <link rel="stylesheet" type="text/css" href="../_static/css/links.css?v=7a4609b2" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Digital Feedback Control" href="control.html" />
    <link rel="prev" title="Signal Processing / IIR Filters" href="proc_iir.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Nucleo Advanced
              <img src="../_static/logo-training_git.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Communication</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="serial.html">     Serial</a></li>
<li class="toctree-l1"><a class="reference internal" href="spi.html">     SPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="i2c.html">     I2C</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Signal Processing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="generate.html">     Generate</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="process.html">     Process</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="proc_dsp.html">     DSP basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_samp.html">     Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_mean.html">     Moving Average</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_fir.html">     FIR Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_iir.html">     IIR Filters</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">     Real-time FFT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fast-fourier-transform-vs-fourier-transform">Fast Fourier Transform vs Fourier transform</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fourier-transform-calculation">Fourier Transform calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dft-calculation">DFT calculation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sampling-and-fft-algorithm">Sampling and FFT algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fft-with-nucleo">FFT with Nucleo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#algorithm">Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-an-mbed6-project">Creating an MBED6 project</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cmsis-dsp-library">CMSIS-DSP library</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-mbedignore-file">Adding a .mbedignore file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-program">Main program</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Control</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="control.html">     Feedback control</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Previous trainings</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://iogs-lense-training.github.io/nucleo-basics/">Basics</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nucleo Advanced</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="process.html">Signal Processing / Process</a></li>
      <li class="breadcrumb-item active">Signal Processing / Real-time FFT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/contents/proc_fft.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="signal-processing-real-time-fft">
<h1>Signal Processing / Real-time FFT<a class="headerlink" href="#signal-processing-real-time-fft" title="Link to this heading"></a></h1>
<p>This section requires mastering the concepts of <a class="reference internal" href="proc_samp.html#proc-samp"><span class="std std-ref">sampling</span></a> and <a class="reference internal" href="proc_dsp.html#proc-dsp"><span class="std std-ref">DSP</span></a>.</p>
<section id="fast-fourier-transform-vs-fourier-transform">
<h2>Fast Fourier Transform vs Fourier transform<a class="headerlink" href="#fast-fourier-transform-vs-fourier-transform" title="Link to this heading"></a></h2>
<p>The interest in the <strong>Fourier transform</strong> lies in its ability to analyze and manipulate signals in various domains. By breaking down a signal into its constituent frequencies, it enables analysis and processing in various fields such as signal processing, communications, and image processing.</p>
<p>The <strong>Fast Fourier Transform</strong> (FFT) is an algorithm that computes the <strong>Discrete Fourier Transform</strong> (DFT) of a sampled signal.</p>
<p><abbr title="Fast Fourier Transform">FFT</abbr> transforms a signal from its time (or spatial - for images) domain into the frequency domain. It accomplishes this by recursively dividing the DFT into smaller DFTs, significantly reducing computation time compared to the standard DFT calculation, making it a fundamental tool for spectral analysis and signal processing applications.</p>
<section id="fourier-transform-calculation">
<h3>Fourier Transform calculation<a class="headerlink" href="#fourier-transform-calculation" title="Link to this heading"></a></h3>
<p>The <strong>Fourier transform</strong> of a function <span class="math notranslate nohighlight">\(f(t)\)</span> is given by the following formula:</p>
<div class="math notranslate nohighlight">
\[\hat{f}(\omega) =  \mathcal{F}\{f(t)\}(\omega) = \int_{-\infty}^{\infty} f(t) \cdot e^{-i\omega t} \, dt\]</div>
<p>Fourier transforms have a lot of remarkable properties. These properties are not addressed in this document, but you can find a lot of ressources on the Internet.</p>
</section>
<section id="dft-calculation">
<h3>DFT calculation<a class="headerlink" href="#dft-calculation" title="Link to this heading"></a></h3>
<p>Based on this sampling, the <abbr title="Discrete Fourier Transform">DFT</abbr> can be calculated by integrating</p>
<div class="math notranslate nohighlight">
\[X[k] = \sum_{n=0}^{N-1} x[n] \cdot e^{-i\frac{2\pi}{N} kn}, \quad k = 0, 1, \ldots, N-1\]</div>
</section>
</section>
<section id="sampling-and-fft-algorithm">
<h2>Sampling and FFT algorithm<a class="headerlink" href="#sampling-and-fft-algorithm" title="Link to this heading"></a></h2>
<p>On cherche ici à calculer le spectre d’un signal analogique à l’aide d’une carte Nucléo.</p>
<p>Il est alors nécessaire d’utiliser une acquisition du signal d’entrée analogique, à un rythme régulier, compatible avec le critère de Shannon. La programmation de ces cartes par le biais du système d’exploitation embarqué MBED limite énormément les capacité d’échantillonnage (temps de conversion autour de 25us). Ici, on utilise un Ticker qui appelle la fonction sample à intervalle régulier.</p>
<p>Les éléments convertis, sur une période donnée, sont alors stockées dans un tableau. Ici, on récupère 256 éléments, dans le tableau Input à un rythme de 40us chacun (fréquence de 25 kHz). Pour optimiser les calculs, il est préférable d’utiliser un nombre d’éléments qui est une puissance de 2, l’ensemble des données et des éléments séquentiels d’un microcontroleur fonctionnant en binaire.</p>
<p>Vient ensuite la partie calculatoire où ici on utilise un algorithme particulier de calcul de la transformée de Fourier appelé FFT (Fast Fourier Transform). Cet algorithme est déjà implémenté dans la bibliothèque dsp.h de MBED. Il se fait dans la partie principale du code mais n’est exécuté que lorsque le sémaphore trig n’est pas bloqué par l’échantillonnage des N valeurs.</p>
<p>Enfin, l’affichage se fait par l’intermédiaire d’un convertisseur numérique-analogique à un rythme de 1 échantillon toutes les 10us environ. Une première impulsion à 3.3V de durée 20us permet de synchroniser l’affichage. Puis les différentes valeurs du spectre sont régulièrement converties par le CNA.</p>
</section>
<section id="fft-with-nucleo">
<h2>FFT with Nucleo<a class="headerlink" href="#fft-with-nucleo" title="Link to this heading"></a></h2>
<p><a class="reference external" href="http://lense.institutoptique.fr/nucleo-obtenir-le-spectre-dun-signal-en-temps-reel-4/">http://lense.institutoptique.fr/nucleo-obtenir-le-spectre-dun-signal-en-temps-reel-4/</a></p>
<section id="algorithm">
<h3>Algorithm<a class="headerlink" href="#algorithm" title="Link to this heading"></a></h3>
</section>
<section id="creating-an-mbed6-project">
<h3>Creating an MBED6 project<a class="headerlink" href="#creating-an-mbed6-project" title="Link to this heading"></a></h3>
</section>
<section id="cmsis-dsp-library">
<h3>CMSIS-DSP library<a class="headerlink" href="#cmsis-dsp-library" title="Link to this heading"></a></h3>
<p>Adding a library by right-click on the active project and select</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/keil_add_mbed_library.png"><img alt="../_images/keil_add_mbed_library.png" src="../_images/keil_add_mbed_library.png" style="width: 70%;" /></a>
</figure>
<p>In the popup window, paste the GitHub link : <a class="reference external" href="https://github.com/ARM-software/CMSIS-DSP">https://github.com/ARM-software/CMSIS-DSP</a> then click Next</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/keil_add_mbed_library_link.png"><img alt="../_images/keil_add_mbed_library_link.png" src="../_images/keil_add_mbed_library_link.png" style="width: 50%;" /></a>
</figure>
<p>Select the version of the library then click Finish.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/keil_add_mbed_library_version.png"><img alt="../_images/keil_add_mbed_library_version.png" src="../_images/keil_add_mbed_library_version.png" style="width: 50%;" /></a>
</figure>
<p>The library is adding in the project.</p>
<figure class="align-default">
<img alt="../_images/keil_add_mbed_library_dl.png" src="../_images/keil_add_mbed_library_dl.png" />
</figure>
</section>
<section id="adding-a-mbedignore-file">
<h3>Adding a .mbedignore file<a class="headerlink" href="#adding-a-mbedignore-file" title="Link to this heading"></a></h3>
<p>Adding a new file by right-click on the active project and select <em>New File</em>.</p>
<p>Create a <code class="file docutils literal notranslate"><span class="pre">.mbedignore</span></code> file.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/keil_add_mbed_library_mbedignore.png"><img alt="../_images/keil_add_mbed_library_mbedignore.png" src="../_images/keil_add_mbed_library_mbedignore.png" style="width: 40%;" /></a>
</figure>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Examples</span><span class="o">/*</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">PythonWrapper</span><span class="o">/*</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Scripts</span><span class="o">/*</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Testing</span><span class="o">/*</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">ComputeLibrary</span><span class="o">/*</span>

<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">BasicMathFunctions</span><span class="o">/</span><span class="n">BasicMathFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">BasicMathFunctions</span><span class="o">/</span><span class="n">BasicMathFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">BayesFunctions</span><span class="o">/</span><span class="n">BayesFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">BayesFunctions</span><span class="o">/</span><span class="n">BayesFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">CommonTables</span><span class="o">/</span><span class="n">CommonTables</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">CommonTables</span><span class="o">/</span><span class="n">CommonTablesF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">ComplexMathFunctions</span><span class="o">/</span><span class="n">ComplexMathFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">ComplexMathFunctions</span><span class="o">/</span><span class="n">ComplexMathFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">ControllerFunctions</span><span class="o">/</span><span class="n">ControllerFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">DistanceFunctions</span><span class="o">/</span><span class="n">DistanceFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">DistanceFunctions</span><span class="o">/</span><span class="n">DistanceFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">FastMathFunctions</span><span class="o">/</span><span class="n">FastMathFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">FastMathFunctions</span><span class="o">/</span><span class="n">FastMathFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">FilteringFunctions</span><span class="o">/</span><span class="n">FilteringFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">FilteringFunctions</span><span class="o">/</span><span class="n">FilteringFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">InterpolationFunctions</span><span class="o">/</span><span class="n">InterpolationFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">InterpolationFunctions</span><span class="o">/</span><span class="n">InterpolationFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">MatrixFunctions</span><span class="o">/</span><span class="n">MatrixFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">MatrixFunctions</span><span class="o">/</span><span class="n">MatrixFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">QuaternionMathFunctions</span><span class="o">/</span><span class="n">QuaternionMathFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">StatisticsFunctions</span><span class="o">/</span><span class="n">StatisticsFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">StatisticsFunctions</span><span class="o">/</span><span class="n">StatisticsFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">SVMFunctions</span><span class="o">/</span><span class="n">SVMFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">SVMFunctions</span><span class="o">/</span><span class="n">SVMFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">TransformFunctions</span><span class="o">/</span><span class="n">TransformFunctions</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">TransformFunctions</span><span class="o">/</span><span class="n">TransformFunctionsF16</span><span class="o">.</span><span class="n">c</span>
<span class="n">cmsis</span><span class="o">-</span><span class="n">dsp</span><span class="o">/</span><span class="n">Source</span><span class="o">/</span><span class="n">WindowFunctions</span><span class="o">/</span><span class="n">WindowFunctions</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Be careful to let a blank line at the end of this file.</p>
</div>
</section>
<section id="main-program">
<h3>Main program<a class="headerlink" href="#main-program" title="Link to this heading"></a></h3>
<section id="sampling-application">
<h4>Sampling application<a class="headerlink" href="#sampling-application" title="Link to this heading"></a></h4>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">DigitalOut</span><span class="w"> </span><span class="nf">myled</span><span class="p">(</span><span class="n">D3</span><span class="p">);</span>
<span class="linenos"> 4</span><span class="n">AnalogIn</span><span class="w">   </span><span class="nf">myADC</span><span class="p">(</span><span class="n">A1</span><span class="p">);</span>
<span class="linenos"> 5</span><span class="n">AnalogOut</span><span class="w">  </span><span class="nf">myDAC</span><span class="p">(</span><span class="n">D13</span><span class="p">);</span>
<span class="linenos"> 6</span><span class="n">Ticker</span><span class="w">     </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">sample</span><span class="p">(){</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">myled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">myled</span><span class="p">;</span>
<span class="linenos">10</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">val_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myADC</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
<span class="linenos">11</span><span class="w">        </span><span class="n">myDAC</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">val_in</span><span class="p">);</span>
<span class="linenos">12</span><span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">15</span><span class="w">        </span><span class="n">timer</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span><span class="w"> </span><span class="mi">40u</span><span class="n">s</span><span class="p">);</span><span class="w">    </span><span class="c1">//40us 25KHz sampling rate</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">18</span><span class="w">                </span><span class="n">thread_sleep_for</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="linenos">19</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">20</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="final-code">
<h4>Final code<a class="headerlink" href="#final-code" title="Link to this heading"></a></h4>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;arm_math.h&quot;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;arm_common_tables.h&quot;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;arm_const_structs.h&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="cp">#define SAMPLES                 512</span>
<span class="linenos"> 7</span><span class="cm">/* 256 real party and 256 imaginary parts */</span>
<span class="linenos"> 8</span><span class="cp">#define FFT_SIZE                SAMPLES / 2</span>
<span class="linenos"> 9</span><span class="cm">/* FFT size is always the same size as we have samples, so 256 in our case */</span>
<span class="linenos">10</span><span class="cp">#define OUTPUT_GAIN             10.0</span>
<span class="linenos">11</span><span class="cm">/* Gain on the output values - for better display */</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="n">float32_t</span><span class="w"> </span><span class="n">Input</span><span class="p">[</span><span class="n">SAMPLES</span><span class="p">];</span>
<span class="linenos">14</span><span class="n">float32_t</span><span class="w"> </span><span class="n">Output</span><span class="p">[</span><span class="n">FFT_SIZE</span><span class="p">];</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="kt">bool</span><span class="w">      </span><span class="n">trig</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w">         </span><span class="c1">// sampling blocking semaphore</span>
<span class="linenos">17</span><span class="kt">int</span><span class="w">       </span><span class="n">indice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="n">DigitalOut</span><span class="w"> </span><span class="nf">myled</span><span class="p">(</span><span class="n">D3</span><span class="p">);</span>
<span class="linenos">20</span><span class="n">AnalogIn</span><span class="w">   </span><span class="nf">myADC</span><span class="p">(</span><span class="n">A1</span><span class="p">);</span>
<span class="linenos">21</span><span class="n">AnalogOut</span><span class="w">  </span><span class="nf">myDAC</span><span class="p">(</span><span class="n">D13</span><span class="p">);</span>
<span class="linenos">22</span><span class="n">Ticker</span><span class="w">     </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="kt">void</span><span class="w"> </span><span class="nf">sample</span><span class="p">(){</span>
<span class="linenos">25</span><span class="w">        </span><span class="n">myled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">indice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">SAMPLES</span><span class="p">){</span>
<span class="linenos">27</span><span class="w">                </span><span class="n">Input</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myADC</span><span class="p">.</span><span class="n">read</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5f</span><span class="p">;</span>
<span class="linenos">28</span><span class="w">                </span><span class="c1">// Real part NB removing DC offset</span>
<span class="linenos">29</span><span class="w">                </span><span class="n">Input</span><span class="p">[</span><span class="n">indice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">                </span><span class="c1">// Imaginary Part set to zero</span>
<span class="linenos">31</span><span class="w">                </span><span class="n">indice</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">33</span><span class="w">        </span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="n">trig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">34</span><span class="w">        </span><span class="n">myled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">35</span><span class="p">}</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">38</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span><span class="w">            </span><span class="c1">// Max FFT value is stored here</span>
<span class="linenos">39</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">maxIndex</span><span class="p">;</span><span class="w">         </span><span class="c1">// Index in Output array where max value is</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">42</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">trig</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="linenos">43</span><span class="w">                        </span><span class="n">timer</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
<span class="linenos">44</span><span class="w">                        </span><span class="c1">// arm_cfft_sR_f32_lenXXX, where XXX is the samples number, here 256</span>
<span class="linenos">45</span><span class="w">                        </span><span class="n">arm_cfft_f32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arm_cfft_sR_f32_len256</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">                        </span><span class="c1">// FFT calculation and storage of the magnitude of the complex FFT values in the Output array</span>
<span class="linenos">48</span><span class="w">                        </span><span class="n">arm_cmplx_mag_f32</span><span class="p">(</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">FFT_SIZE</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">                        </span><span class="n">Output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="w">                        </span><span class="c1">// Analog display of the FFT</span>
<span class="linenos">52</span><span class="w">                        </span><span class="n">myDAC</span><span class="o">=</span><span class="mf">1.0f</span><span class="p">;</span><span class="w">     </span><span class="c1">// Sync pulse</span>
<span class="linenos">53</span><span class="w">                        </span><span class="n">wait_us</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">                        </span><span class="n">myDAC</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">55</span><span class="w">                        </span><span class="c1">// Display all the values</span>
<span class="linenos">56</span><span class="w">                        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">FFT_SIZE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="linenos">57</span><span class="w">                                </span><span class="n">myDAC</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">OUTPUT_GAIN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">FFT_SIZE</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">                        </span><span class="p">}</span>
<span class="linenos">59</span><span class="w">                        </span><span class="n">myDAC</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="w">                        </span><span class="c1">// Restart sampling</span>
<span class="linenos">62</span><span class="w">                        </span><span class="n">trig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">63</span><span class="w">                        </span><span class="n">indice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">64</span><span class="w">                        </span><span class="n">timer</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sample</span><span class="p">,</span><span class="mi">40u</span><span class="n">s</span><span class="p">);</span><span class="w">    </span><span class="c1">//40us 25KHz sampling rate</span>
<span class="linenos">65</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">66</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">67</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="proc_iir.html" class="btn btn-neutral float-left" title="Signal Processing / IIR Filters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="control.html" class="btn btn-neutral float-right" title="Digital Feedback Control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Julien Villemejane.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>